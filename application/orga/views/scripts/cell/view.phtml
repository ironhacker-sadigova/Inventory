<?php
use Orga\Model\ACL\Role\CellAdminRole;
use Orga\Model\ACL\Role\CellManagerRole;
use Orga\Model\ACL\Role\CellContributorRole;
use Orga\Model\ACL\Role\CellObserverRole;
$inventoryStatusFilters = [
    null => 'Toute collecte',
    Orga_Model_Cell::STATUS_NOTLAUNCHED => __('Orga', 'inventory', 'notLaunched'),
    Orga_Model_Cell::STATUS_ACTIVE => __('UI', 'property', 'open'),
    Orga_Model_Cell::STATUS_CLOSED => __('UI', 'property', 'closed'),
];
$inputStatusFilters = [
    null => 'Tout status',
    AF_Model_InputSet_Primary::STATUS_FINISHED => __('AF', 'inputInput', 'statusFinished'),
    AF_Model_InputSet_Primary::STATUS_COMPLETE => __('AF', 'inputInput', 'statusComplete'),
    AF_Model_InputSet_Primary::STATUS_CALCULATION_INCOMPLETE => __('AF', 'inputInput', 'statusCalculationIncomplete'),
    AF_Model_InputSet_Primary::STATUS_INPUT_INCOMPLETE => __('AF', 'inputInput', 'statusInputIncomplete'),
    'notStarted' => __('AF', 'inputInput', 'statusNotStarted'),
];
?>

<style>
    .progress { margin-bottom: 5px; }
    .progress { position: relative; }
    .bar { z-index: 1; position: absolute; }
    .progress span { position: absolute; top: 0; z-index: 2; color: #000000; opacity: 0.8; text-align: center; width: 100%; }

    .cellActions a { margin-left: 8px; padding: 5px; }
    .cellActions a:hover, .users .modal-body a:hover, .reports .modal-body a:hover { opacity: 0.25; }

    .users .userMessage { font-weight: bold; }
    .users .modal-body { padding: 0; }
    .users .modal-body table { margin: 0; }
    .users .modal-body tr.userMessage td:first-child { text-align: center; }
    .users .modal-body tr.userMessage .btn { margin: 0 5px 0 5px; }
    .users .modal-body tr.userMessage .closeUserMessage { float: none; font-size: inherit; opacity: 1; }
    .users .modal-body .deleteUser + .tooltip.left { margin-left: -15px; }
    .users .modal-footer div.userMessage { text-align: center; margin-bottom: 5px; }
    .users .modal-footer form { margin: 0; }
    
    .reports .reportMessage { font-weight: bold; }
    .reports .modal-body { padding: 0; }
    .reports .modal-body table { margin: 0; }
    .reports .modal-body tr.reportMessage td:first-child { text-align: center; }
    .reports .modal-body tr.reportMessage .btn { margin: 0 5px 0 5px; }
    .reports .modal-body tr.reportMessage .closeReportMessage { float: none; font-size: inherit; opacity: 1; }
    .reports .modal-body .deleteReport + .tooltip.left { margin-left: -15px; }

    .exports .modal-body { text-align: center; }
    .exports .modal-body .alert { margin-bottom: 5px; }
    .exports .modal-body form { margin: 0; }

    .granularity .cellActions { float: right; }
    .granularity > .cell.firstRowCell { margin-left: 0; }

    #addMembers { margin: 0; }
    #addMembers .controls { margin-left: 0; }
    #addMembers .subGroup { margin-left: 0; }
    #addMembers label { text-align: left; width: 35%; }
    #addMembers .input { width: auto; }
    #addMembers .form-actions { padding: 10px 0 0 0; margin: 0; background-color: inherit; text-align: center; border: none; }
</style>

<?php
/** @var \Orga\ViewModel\OrganizationViewModel $organization */
$organization = $this->organization;
?>
<div class="organization page-header">
    <h1>
        <?=$organization->label?>
        <?php if ($organization->canBeEdited) : ?>
        <div class="pull-right">
            <small>
                <a class="editOrganization btn btn-small btn-primary"
                   href="orga/organization/edit/idOrganization/<?=$organization->id?>">
                    <i class="icon-cog icon-white"></i>
                    <?=__('UI', 'verb', 'edit')?>
                </a>
            </small>
        </div>
        <?php endif; ?>
    </h1>
</div>

<div class="row-fluid">

    <div class="span9">

        <?php
        /** @var \Orga\ViewModel\CellViewModel $currentCell */
        $currentCell = $this->currentCell;
        ?>
        <div class="currentCell well">
            <h2>
                <?php if ($currentCell->canBeInputted) : ?>
                <a href="orga/cell/input/idCell/<?=$currentCell->id?>/fromIdCell/<?=$currentCell->id?>/" title="<?=__('Orga', 'view', 'viewInput')?>" class="withTooltip">
                    <?php endif; ?>
                    <?=$currentCell->extendedLabel?>
                <?php if ($currentCell->canBeInputted) : ?>
                </a>
                <?php endif; ?>
                <small class="cellActions">
                    <a data-toggle="modal" href="#administrators<?=$currentCell->id?>" title="<?=__('Orga', 'view', 'viewAdministrators')?>" class="withTooltip"><i class="icon-envelope"></i></a>
                    <?php if ($currentCell->allowACL) : ?>
                        <a data-toggle="modal" href="#users<?=$currentCell->id?>" title="<?=__('Orga', 'view', 'viewUsers')?>" class="withTooltip"><i class="icon-user"></i></a>
                    <?php endif; ?>
                    <?php if ($currentCell->canBeAnalyzed) : ?>
                        <a data-toggle="modal" href="#reports<?=$currentCell->id?>" title="<?=__('Orga', 'view', 'viewReports')?>" class="withTooltip"><i class="icon-tasks"></i></a>
                        <a data-toggle="modal" data-target="#exports<?=$currentCell->id?>" href="orga/cell/view-exports/idCell/<?=$currentCell->id?>/" title="<?=__('Orga', 'view', 'viewExports')?>" class="withTooltip"><i class="icon-download-alt"></i></a>
                    <?php endif; ?>
                </small>
            </h2>
            <?php // Inventory ?>
            <?php if ($currentCell->inventoryStatus !== null) : ?>
            <p>
                <b><?=__('Orga', 'inventory', 'inventoryStatus')?>&nbsp;:&nbsp;</b>
                <?=$currentCell->inventoryStatus?>
            </p>
            <div class="progress">
                <div class="bar" style="width: <?=$currentCell->inventoryCompletion?>%"></div>
                <span>
                    <?=$currentCell->inventoryNotStartedInputsNumber?>
                    <?=($currentCell->inventoryNotStartedInputsNumber > 1) ? __('Orga', 'view', 'inputsNotStartedMany') : __('Orga', 'view', 'inputsNotStartedSingle')?>
                    |
                    <?=$currentCell->inventoryStartedInputsNumber?>
                    <?=($currentCell->inventoryStartedInputsNumber > 1) ? __('Orga', 'view', 'inputsStartedMany') : __('Orga', 'view', 'inputsStartedSingle')?>
                    |
                    <?=$currentCell->inventoryCompletedInputsNumber?>
                    <?=($currentCell->inventoryCompletedInputsNumber > 1) ? __('Orga', 'view', 'inputsCompletedMany') : __('Orga', 'view', 'inputsCompletedSingle')?>
                </span>
            </div>
            <?php endif; ?>
            <?php // Input ?>
            <?php if ($currentCell->canBeInputted) : ?>
            <p>
                <b><?=__('Orga', 'input', 'inputStatus')?>&nbsp;:&nbsp;</b>
                <?=$currentCell->inputStatusTitle?>
            </p>
            <div class="progress <?=$currentCell->inputStatusStyle?>">
                <div class="bar" style="width: <?=$currentCell->inputCompletion?>%"><?=$currentCell->inputCompletion?> %</div>
            </div>
            <?php endif; ?>

            <div id="administrators<?=$currentCell->id?>" class="modal administrators hide fade">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?=__('Orga', 'view', 'administratorsFrom')?> <?=$currentCell->shortLabel?></h4>
                </div>
                <div class="modal-body">
                    <pre><?=implode("\n", $currentCell->administrators)?></pre>
                </div>
            </div>
            <?php if ($currentCell->allowACL) : ?>
            <div id="users<?=$currentCell->id?>" class="modal users hide fade large" data-cell="<?=$currentCell->id?>">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?=__('Orga', 'view', 'usersFrom')?> <?=$currentCell->shortLabel?></h4>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <form class="form-inline addUser" action="orga/cell/add-user/idCell/<?=$currentCell->id?>/">
                        <input type="text" name="userEmail" placeholder="<?=__('Orga', 'view', 'userEmailPlaceholder')?>">
                        <select name="userRole">
                            <option value="CellAdminRole"><?=CellAdminRole::getLabel()?></option>
                            <option value="CellManagerRole"><?=CellManagerRole::getLabel()?></option>
                            <option value="CellContributorRole"><?=CellContributorRole::getLabel()?></option>
                            <option value="CellObserverRole"><?=CellObserverRole::getLabel()?></option>
                        </select>
                        <button type="submit" class="btn btn-primary">
                            <i class="icon-plus icon-white"></i>
                            <?=__('Orga', 'view', 'addUser')?>
                        </button>
                    </form>
                </div>
            </div>
            <?php endif; ?>
            <?php if ($currentCell->canBeAnalyzed) : ?>
            <div id="reports<?=$currentCell->id?>" class="modal reports hide fade large" data-cell="<?=$currentCell->id?>">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?=__('Orga', 'view', 'reportsFrom')?> <?=$currentCell->shortLabel?></h4>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <a href="orga/cell/view-report/idCell/<?=$currentCell->id?>/" class="btn btn-primary">
                        <i class="icon-plus icon-white"></i>
                        <?=__('Orga', 'view', 'addReport')?>
                    </a>
                </div>
            </div>
            <div id="exports<?=$currentCell->id?>" class="modal exports hide fade">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4><?=__('Orga', 'view', 'exportsFrom')?> <?=$currentCell->shortLabel?></h4>
                </div>
                <div class="modal-body">
                    <div class="granularity row-fluid">
                        <img src="images/ui/ajax-loader_large.gif">
                        <?=__('Orga', 'view', 'loadingExports')?>
                    </div>
                </div>
            </div>
            <?php endif; ?>
        </div>

        <?php foreach ($this->narrowerGranularities as $narrowerGranularityArray) :
            /** @var Orga_Model_Granularity $narrowerGranularity */
            $narrowerGranularity = $narrowerGranularityArray['granularity'];
        ?>
        <fieldset class="wrapper">
            <legend data-toggle="collapse" data-target="#granularity<?=$narrowerGranularity->getId()?>">
                <i class="filterChevron icon-chevron-down"></i>
                <?=$narrowerGranularity->getLabel()?>
                <small>
                    <?=$narrowerGranularityArray['purpose']?>
                </small>
            </legend>

            <div id="granularity<?=$narrowerGranularity->getId()?>" class="collapse">
                <?php if ($narrowerGranularity->hasAxes() || ($narrowerGranularity->getInputConfigGranularity() !== null)) : ?>
                <form class="form-inline cells-filter">
                    <?php foreach ($narrowerGranularityArray['filterAxes'] as $memberOptions) : ?>
                        <select data-filter="tag">
                            <?php foreach ($memberOptions as $memberTag => $memberLabel) : ?>
                                <option value="<?=$memberTag?>"><?=$memberLabel?></option>
                            <?php endforeach; ?>
                        </select>
                    <?php endforeach; ?>
                    <?php if ($narrowerGranularityArray['isInput']) : ?>
                        <select data-filter="inputstatus">
                            <?php foreach ($inputStatusFilters as $statusValue => $statusLabel) : ?>
                                <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                            <?php endforeach; ?>
                        </select>
                    <?php endif; ?>
                    <?php if ($narrowerGranularityArray['isInventory']) : ?>
                        <select data-filter="inventorystatus">
                            <?php foreach ($inventoryStatusFilters as $statusValue => $statusLabel) : ?>
                                <? if ($statusValue === Orga_Model_Cell::STATUS_ACTIVE) : ?>
                                    <option value="<?=$statusValue?>" selected><?=$statusLabel?></option>
                                <?php else: ?>
                                    <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                                <?php endif ?>
                            <?php endforeach ?>
                        </select>
                    <?php endif; ?>
                    <button class="btn reset"><i class="icon-zoom-out"></i> Reset</button>
                </form>
                <?php endif; ?>

                <div class="granularity row-fluid">
                    <img src="images/ui/ajax-loader_large.gif">
                    <?=__('Orga', 'view', 'loadingCells')?>
                </div>
            </div>
        </fieldset>
        <?php endforeach; ?>

    </div>

    <div class="span3">
        <div class="history">
            <h3>
                <?=__('UI', 'history', 'history')?>
                <small class="pull-right"><i class="icon-refresh"></i></small>
            </h3>
            <hr/>
            <div>
                <?=__('Orga', 'view', 'notLoadedHistory')?>
            </div>
        </div>
        <div class="comments">
            <h3>
                <?=__('Social', 'comment', 'comment')?>
                <small class="pull-right"><i class="icon-refresh"></i></small>
            </h3>
            <hr/>
            <div>
                <?=__('Orga', 'view', 'notLoadedComments')?>
            </div>
        </div>
        <?php if ($organization->canBeEdited) : ?>
            <div class="addMember">
                <h3>
                    <?=__('Orga', 'view', 'addMember')?>
                    <div class="pull-right">
                        <small>
                            <a class="editOrganization btn btn-small btn-primary"
                               href="orga/organization/edit/idOrganization/<?=$organization->id?>/tab/members/">
                                <i class="icon-cog icon-white"></i>
                                <?=__('UI', 'verb', 'edit')?>
                            </a>
                        </small>
                    </div>
                </h3>
                <hr/>
                <?=$this->addMembersForm->display()?>
            </div>
        <?php endif; ?>
    </div>

</div>
<script>
    $('.history .icon-refresh').click(function(e) {
        $('.history > div').html('<img src="images/ui/ajax-loader_large.gif"> <?=addslashes(__('UI', 'history', 'loadingHistory'))?>');
        $.ajax({
            url: 'orga/cell/view-history/idCell/<?=$currentCell->id?>/',
            type: "GET",
            success: function(data) {
                if (data.length > 0) {
                    $('.history > div').html('<dl class="dl-horizontal"></dl>');
                    $.each(data, function() {
                        $('.history > div dl').append('<dt><span class="badge badge-info">' + this.date + '</span></dt>');
                        $('.history > div dl').append('<dd>' + this.event + '</dd>');
                    });
                } else {
                    $('.history > div').html('<p><?=__('UI', 'history', 'noHistory')?></p>');
                }
            },
            error: function(jqXHR) {
                $('.history > div').html('<?=addslashes(__('UI', 'history', 'errorWhileLoadingHistory'))?>');
            }
        });
    });
    $('.comments .icon-refresh').click(function(e) {
        $('.comments > div').html('<img src="images/ui/ajax-loader_large.gif"> <?=addslashes(__('UI', 'comment', 'loadingComments'))?>');
        $.ajax({
            url: 'orga/cell/view-comments/idCell/<?=$currentCell->id?>/',
            type: "GET",
            success: function(data) {
                if (data.length > 0) {
                    $('.comments > div').html('<dl class="dl-horizontal"></dl>');
                    $.each(data, function() {
                        $('.comments > div dl').append('<dt><span class="badge badge-info">' + this.date + '</span></dt>');
                        $('.comments > div dl').append('<dd>' + this.event + '</dd>');
                    });
                } else {
                    $('.comments > div').html('<p><?=addslashes(__('UI', 'comment', 'noComment'))?></p>');
                }
            },
            error: function(jqXHR) {
                $('.comments > div').html('<?=addslashes(__('UI', 'comment', 'errorWhileLoadingComments'))?>');
            }
        });
    });
    $('div.collapse[id^="granularity"]').on('show', function(e) {
        if (e.target != this) {
            return;
        }
        var granularity = $('.granularity', $(this));
        if (!granularity.data('initialized')) {
            var granularityId = $(this).attr('id').substr(11, $(this).attr('id').length);
            $.ajax({
                url: 'orga/cell/view-children/idCell/<?=$currentCell->id?>/idGranularity/' + granularityId + '/',
                type: "GET",
                success: function(data) {
                    granularity.html('');
                    $(data).each(function() {
                        var cellTitle = this.extendedLabel;
                        if (this.canBeInputted) {
                            cellTitle = '<a href="orga/cell/input/idCell/23/fromIdCell/' + this.id + '/" title="<?=__('Orga', 'view', 'viewInput')?>" class="withTooltip">' + cellTitle + '</a>';
                        }
                        var usersP = '';
                        var usersPopup = '';
                        if (this.allowACL) {
                            usersP =
                                '<a data-toggle="modal" href="#users' + this.id + '" title="<?=__('Orga', 'view', 'viewUsers')?>" class="withTooltip">' +
                                    '<i class="icon-user"></i>' +
                                '</a>';
                            usersPopup =
                                '<div id="users' + this.id + '" class="modal users hide fade large" data-cell="' + this.id + '">' +
                                    '<div class="modal-header">' +
                                        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                        '<h4><?=__('Orga', 'view', 'usersFrom')?> ' + this.shortLabel + '</h4>' +
                                    '</div>' +
                                    '<div class="modal-body">' +
                                    '</div>' +
                                    '<div class="modal-footer">' +
                                        '<form class="form-inline addUser" action="orga/cell/add-user/idCell/' + this.id + '/">' +
                                            '<input type="text" placeholder="<?=__('Orga', 'view', 'userEmailPlaceholder')?>" name="userEmail"> ' +
                                            '<select name="userRole">' +
                                                '<option value="CellAdminRole"><?=CellAdminRole::getLabel()?></option>' +
                                                '<option value="CellManagerRole"><?=CellManagerRole::getLabel()?></option>' +
                                                '<option value="CellContributorRole"><?=CellContributorRole::getLabel()?></option>' +
                                                '<option value="CellObserverRole"><?=CellObserverRole::getLabel()?></option>' +
                                            '</select> ' +
                                            '<input type="submit" class="btn btn-primary" value="<?=__('Orga', 'view', 'addUser')?>"> ' +
                                        '</form>' +
                                    '</div>' +
                                '</div>';
                        }
                        var reportsP = '';
                        var reportsPopup = '';
                        var exportsP = '';
                        var exportsPopup = '';
                        if (this.canBeAnalyzed) {
                            reportsP =
                                '<a data-toggle="modal" href="#reports' + this.id + '" title="<?=__('Orga', 'view', 'viewReports')?>" class="withTooltip">' +
                                    '<i class="icon-tasks"></i>' +
                                '</a>';
                            reportsPopup =
                                '<div id="reports' + this.id + '" class="modal reports hide fade large" data-cell="' + this.id + '">' +
                                    '<div class="modal-header">' +
                                        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                        '<h4><?=__('Orga', 'view', 'reportsFrom')?>' + this.shortLabel + '</h4>' +
                                    '</div>' +
                                    '<div class="modal-body">' +
                                    '</div>' +
                                    '<div class="modal-footer">' +
                                        '<a href="orga/cell/view-report/idCell/' + this.id + '/" class="btn btn-primary">' +
                                            '<i class="icon-plus icon-white"></i> ' +
                                            '<?=__('Orga', 'view', 'addReport')?>' +
                                        '</a>' +
                                    '</div>' +
                                '</div>';
                        exportsP =
                            '<a data-toggle="modal" data-target="#exports' + this.id + '" href="orga/cell/view-exports/idCell/' + this.id + '/" title="<?=__('Orga', 'view', 'viewExports')?>" class="withTooltip">' +
                                '<i class="icon-download-alt"></i>' +
                            '</a>';
                        exportsPopup =
                            '<div id="exports' + this.id + '" class="modal exports hide fade">' +
                                '<div class="modal-header">' +
                                    '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                    '<h4><?=__('Orga', 'view', 'exportsFrom')?> ' + this.shortLabel + '</h4>' +
                                '</div>' +
                                '<div class="modal-body">' +
                                    '<img src="images/ui/ajax-loader_large.gif"> ' +
                                    '<?=__('Orga', 'view', 'loadingExports')?>' +
                                '</div>' +
                            '</div>';
                        }
                        var inventoryP = '';
                        if ((this.inventoryStatus != null) && ((this.inventoryNotStartedInputsNumber + this.inventoryStartedInputsNumber + this.inventoryCompletedInputsNumber) > 1)) {
                            inventoryP =
                                '<p><b><?=__('Orga', 'inventory', 'inventoryStatus')?>&nbsp;:&nbsp;</b>' + this.inventoryStatusTitle + '</p>' +
                                '<p>' +
                                    this.inventoryNotStartedInputsNumber + ' ' +
                                    ((this.inventoryNotStartedInputsNumber > 1) ? '<?=__('Orga', 'view', 'inputsNotStartedMany')?>' : '<?=__('Orga', 'view', 'inputsNotStartedSingle')?>') +
                                    ' | ' +
                                    this.inventoryStartedInputsNumber + ' ' +
                                    ((this.inventoryStartedInputsNumber > 1) ? '<?=__('Orga', 'view', 'inputsStartedMany')?>' : '<?=__('Orga', 'view', 'inputsStartedSingle')?>') +
                                    ' | ' +
                                    this.inventoryCompletedInputsNumber + ' ' +
                                    ((this.inventoryCompletedInputsNumber > 1) ? '<?=__('Orga', 'view', 'inputsCompletedMany')?>' : '<?=__('Orga', 'view', 'inputsCompletedSingle')?>') +
                                '</p>' +
                                '<div class="progress">' +
                                    '<div class="bar" style="width: ' + this.inventoryCompletion + '%">' + this.inventoryCompletion + '%</div>' +
                                '</div>';
                        }
                        var inputStatusP = '';
                        if (this.canBeInputted) {
                            inputStatusP =
                                '<p><b><?=__('Orga', 'input', 'inputStatus')?>&nbsp;:&nbsp;</b>' + this.inputStatusTitle + '</p>' +
                                '<div class="progress ' + this.inputStatusStyle + '">' +
                                '   <div class="bar" style="width: ' + this.inputCompletion + '%">' + this.inputCompletion + ' %</div>' +
                                '</div>';
                        }
                        granularity.append(
                        '<div class="span4 well cell" data-tag="' + this.tag + '" data-inputstatus="' + this.inputStatus + '" data-inventorystatus="' + this.inventoryStatus + '">' +
                            '<h4>'
                            + cellTitle +
                            '<small class="cellActions">' +
                            usersP +
                            reportsP +
                            exportsP +
                            '</small>' +
                            '</h4>' +
                            inventoryP +
                            inputStatusP +
                            usersPopup +
                            reportsPopup +
                            exportsPopup +
                        '</div>'
                        );
                    });
                    $('select:first', granularity.parent()).trigger('change');
                    $('.withTooltip', granularity).tooltip();
//                    granularity.data('initialized', true);
                },
                error: function(jqXHR) {}
            });
        }
    });
    $('.cells-filter button.reset').click(function(e) {
        e.preventDefault();
        var form = $(e.target).parent();
        var granularity = form.next();
        $('.cell', granularity).removeClass('hide');
        $('.cell', granularity).removeClass('firstRowCell');
        $('.cell:nth-child(3n+1)', granularity).each(function() { $(this).addClass('firstRowCell'); });
        $('select', form).each(function() { $(this).val(''); });
    });
    $('.cells-filter select').change(function(e) {
        e.preventDefault();
        var form = $(e.target).parent();
        var granularity = form.next();

        $('.cell', granularity).removeClass('hide');
        $('.cell', granularity).removeClass('firstRowCell');

        var test = '';
        $('select', form).each(function() {
            var filter = $(this).data('filter');
            var value = $(this).val();
            if ((filter == 'inputstatus') && (value == 'notStarted')) {
                test += '[data-' + filter + '=\'\']';
            } else if (value != '') {
                test += '[data-' + filter + '*=\'' + value + '\']';
            }
        });
        if (test != '') {
            $('.cell:not('+ test + ')', granularity).addClass('hide');
        }

        var numberElement = 0;
        $('.cell:not(.hide)', granularity).each(function() {
            if ((numberElement % 3) == 0) {
                $(this).addClass('firstRowCell');
            }
            numberElement++;
        });
    });

    $('body').on('show', '.users', function(e) {
        if (e.target != this) {
            return;
        }
        var popup = $(this);
        $('.modal-body', popup).html(
            '<img src="images/ui/ajax-loader_large.gif"> <?=__('Orga', 'view', 'loadingUsers')?>'
        );
        $.ajax({
            url: 'orga/cell/view-users/idCell/' + popup.data('cell') + '/',
            type: "GET",
            success: function(data) {
                $('.modal-body', popup).html(data);
            },
            error: function(jqXHR) {
                $('.modal-body', popup).html('<?=__('Orga', 'view', 'errorWhileLoadingUsers')?>');
            }
        });
    });
    $('body').on('hidden', '.users', function(e) {
        if (e.target != this) {
            return;
        }
        var popup = $(this);
        $('.userMessage', popup).remove();
        $('.modal-footer form input[name="userEmail"]', popup).val('');
    });
    $('body').on('click', '.deleteUser', function(e) {
        e.preventDefault();
        $('.userMessage').remove();
        $(this).parent().parent().after(
            '<tr class="info userMessage">' +
                '<td colspan="5">' +
                    '<?=__('Orga', 'view', 'askConfirmDeleteUser')?>' +
                    $(this).parent().prev().prev().html() +
                    '<button class="btn btn-primary confirm"><i class="icon-ok icon-white"></i> <?=__('Orga', 'view', 'confirmDeleteUser')?></button>' +
                    '<button class="btn closeUserMessage"><i class="icon-remove"></i> <?=__('Orga', 'view', 'confirmDeleteUser')?></button>' +
                '</td>' +
            '</tr>'
        );
    });
    $('body').on('click', 'tr.userMessage .confirm', function(e) {
        e.preventDefault();
        var row = $(this).parent().parent();
        row.html('<td colspan="5"><img src="images/ui/ajax-loader.gif"></td>');
        $.ajax({
            url: $('a.deleteUser', row.prev()).attr('href'),
            type: "POST",
            success: function(data) {
                row.prev().remove();
                row.removeClass('info');
                row.addClass('success');
                row.html(
                    '<td colspan="4">' + data + '</td>' +
                    '<td><button class="close closeUserMessage"><i class="icon-remove"></i></button></td>'
                );
            },
            error: function(jqXHR) {
                row.removeClass('info');
                var response = $.parseJSON(jqXHR.responseText);
                if (typeof(response.typeError) == 'string') {
                    row.addClass(response.typeError);
                } else {
                    row.addClass('error');
                }
                if (typeof(response.message) == 'string') {
                    row.html(
                        '<td colspan="4">' + response.message + '</td>' +
                        '<td><button class="close closeUserMessage"><i class="icon-remove"></i></button></td>'
                    );
                } else {
                    row.html(
                        '<td colspan="4"><?=__('Orga', 'view', 'errorWhileDeletingUser')?></td>' +
                        '<td><button class="close closeUserMessage"><i class="icon-remove"></i></button></td>'
                    );
                }
            }
        });
    });
    $('body').on('click', 'tr.userMessage .closeUserMessage', function(e) {
        e.preventDefault();
        $(this).parent().parent().remove();
    });
    $('body').on('submit', '.addUser', function(e) {
        e.preventDefault();
        var form = $(this);
        $('.userMessage').remove();
        form.before('<div class="userMessage alert alert-info"><img src="images/ui/ajax-loader.gif"></div>')
        $.ajax({
            url: form.attr('action'),
            type: "POST",
            data: form.serialize(),
            success: function(data) {
                form.prev().removeClass('alert-info');
                form.prev().addClass('alert-success');
                form.prev().html(data);
                form.parent().parent().trigger('show');
            },
            error: function(jqXHR) {
                form.prev().removeClass('alert-info');
                var response = $.parseJSON(jqXHR.responseText);
                if (typeof(response.typeError) == 'string') {
                    form.prev().addClass('alert-' + response.typeError);
                } else {
                    form.prev().addClass('alert-error');
                }
                if (typeof(response.message) == 'string') {
                    form.prev().html(response.message);
                } else {
                    form.prev().html('<?=__('Orga', 'view', 'errorWhileAddingUser')?>');
                }
            }
        });
    });

    $('body').on('show', '.reports', function(e) {
        if (e.target != this) {
            return;
        }
        var popup = $(this);
        $('.modal-body', popup).html(
            '<img src="images/ui/ajax-loader_large.gif"> <?=__('Orga', 'view', 'loadingReports')?>'
        );
        $.ajax({
            url: 'orga/cell/view-reports/idCell/' + popup.data('cell') + '/',
            type: "GET",
            success: function(data) {
                $('.modal-body', popup).html(data);
            },
            error: function(jqXHR) {
                $('.modal-body', popup).html('<?=__('Orga', 'view', 'errorWhileLoadingReports')?>');
            }
        });
    });
    $('body').on('hidden', '.reports', function(e) {
        if (e.target != this) {
            return;
        }
        var popup = $(this);
        $('.reportMessage', popup).remove();
    });
    $('body').on('click', '.deleteReport', function(e) {
        e.preventDefault();
        $('.reportMessage').remove();
        $(this).parent().parent().after(
            '<tr class="info reportMessage">' +
                '<td colspan="3">' +
                    '<?=__('Orga', 'view', 'askConfirmDeleteReport')?>' +
                    $('a', $(this).parent().prev().prev()).html() +
                    '<button class="btn btn-primary confirm"><i class="icon-ok icon-white"></i> <?=__('Orga', 'view', 'confirmDeleteReport')?></button>' +
                    '<button class="btn closeReportMessage"><i class="icon-remove"></i> <?=__('Orga', 'view', 'cancelDeleteReport')?></button>' +
                '</td>' +
            '</tr>'
        );
    });
    $('body').on('click', 'tr.reportMessage .confirm', function(e) {
        e.preventDefault();
        var row = $(this).parent().parent();
        row.html('<td colspan="3"><img src="images/ui/ajax-loader.gif"></td>');
        $.ajax({
            url: $('a.deleteReport', row.prev()).attr('href'),
            type: "POST",
            success: function(data) {
                row.prev().remove();
                row.removeClass('info');
                row.addClass('success');
                row.html(
                    '<td colspan="2">' + data + '</td>' +
                    '<td><button class="close closeReportMessage"><i class="icon-remove"></i></button></td>'
                );
            },
            error: function(jqXHR) {
                row.removeClass('info');
                var response = $.parseJSON(jqXHR.responseText);
                if (typeof(response.typeError) == 'string') {
                    row.addClass(response.typeError);
                } else {
                    row.addClass('error');
                }
                if (typeof(response.message) == 'string') {
                    row.html(
                        '<td colspan="2">' + response.message + '</td>' +
                        '<td><button class="close closeReportMessage"><i class="icon-remove"></i></button></td>'
                    );
                } else {
                    row.html(
                        '<td colspan="2"><?=__('Orga', 'view', 'errorWhileDeletingReport')?></td>' +
                        '<td><button class="close closeReportMessage"><i class="icon-remove"></i></button></td>'
                    );
                }
            }
        });
    });
    $('body').on('click', 'tr.reportMessage .closeReportMessage', function(e) {
        e.preventDefault();
        $(this).parent().parent().remove();
    });

    $(document).ready(function() {
        $('.withTooltip').tooltip();
        $('.history .icon-refresh').trigger('click');
        $('.comments .icon-refresh').trigger('click');
    });
</script>
