<?php
use Orga\ViewModel\CellViewModelFactory;
use Orga\Model\ACL\Role\CellAdminRole;
use Orga\Model\ACL\Role\CellManagerRole;
use Orga\Model\ACL\Role\CellContributorRole;
use Orga\Model\ACL\Role\CellObserverRole;

/** @var CellViewModelFactory $cellVWFactory */
$cellVWFactory = $this->cellVWFactory;
$inventoryStatusFilters = [
    null => 'Toute collecte',
    Orga_Model_Cell::STATUS_NOTLAUNCHED => __('Orga', 'inventory', 'notLaunched'),
    Orga_Model_Cell::STATUS_ACTIVE => __('UI', 'property', 'open'),
    Orga_Model_Cell::STATUS_CLOSED => __('UI', 'property', 'closed'),
];
$inputStatusFilters = [
    null => 'Tout status',
    AF_Model_InputSet_Primary::STATUS_FINISHED => __('AF', 'inputInput', 'statusFinished'),
    AF_Model_InputSet_Primary::STATUS_COMPLETE => __('AF', 'inputInput', 'statusComplete'),
    AF_Model_InputSet_Primary::STATUS_CALCULATION_INCOMPLETE => __('AF', 'inputInput', 'statusCalculationIncomplete'),
    AF_Model_InputSet_Primary::STATUS_INPUT_INCOMPLETE => __('AF', 'inputInput', 'statusInputIncomplete'),
    'notStarted' => __('AF', 'inputInput', 'statusNotStarted'),
];

/** @var \Orga\ViewModel\OrganizationViewModel $organization */
$organization = $this->organization;
/** @var \Orga\ViewModel\CellViewModel $currentCell */
$currentCell = $this->currentCell;
?>

<style>
    .label-danger, .badge-danger { background-color: #b94a48; }
    .label-important[href], .badge-important[href] { background-color: #953B39; }
    .progress { margin-bottom: 5px; margin-top: 5px; }

    .cellActions a { margin-left: 8px; padding: 5px; }
    .cellActions a:hover, .users .modal-body a:hover, .reports .modal-body a:hover { opacity: 0.25; }

    .users .userMessage { font-weight: bold; }
    .users .modal-body { padding: 0; }
    .users .modal-body table { margin: 0; }
    .users .modal-body tr.userMessage td:first-child { text-align: center; }
    .users .modal-body tr.userMessage .btn { margin: 0 5px 0 5px; }
    .users .modal-body tr.userMessage .closeUserMessage { float: none; font-size: inherit; opacity: 1; }
    .users .modal-body .deleteUser + .tooltip.left { margin-left: -15px; }
    .users .modal-footer div.userMessage { text-align: center; margin-bottom: 5px; }
    .users .modal-footer form { margin: 0; }

    .reports .reportMessage { font-weight: bold; }
    .reports .modal-body { padding: 0; }
    .reports .modal-body table { margin: 0; }
    .reports .modal-body tr.reportMessage td:first-child { text-align: center; }
    .reports .modal-body tr.reportMessage .btn { margin: 0 5px 0 5px; }
    .reports .modal-body tr.reportMessage .closeReportMessage { float: none; font-size: inherit; opacity: 1; }
    .reports .modal-body .deleteReport + .tooltip.left { margin-left: -15px; }

    .exports .modal-body { text-align: center; }
    .exports .modal-body .alert { margin-bottom: 5px; }
    .exports .modal-body form { margin: 0; }

    .inventoryStatus .label { font-size: 14px; font-weight: normal; line-height: 20px; padding: 4px 12px; }
    .inputStatus .badge { font-size: 14px; font-weight: normal; line-height: 20px; padding: 4px 12px; }

    .granularityWrapper .cells-filter > * { margin-top: 2px; }
    .granularityWrapper .cells-filter .granularityInfo { vertical-align: middle; font-size: 14px; font-weight: normal; line-height: 20px; padding: 4px 12px; }
    .granularityWrapper .granularity .cellActions { float: right; }

    .history { margin-bottom: 15px; }
    .history > h3 { margin: 0; }
    .history > hr { margin: 0 0 5px; }
    .history > div { text-align: center; }
    .history h4 { margin: 0 0 5px; }
    .history .dl-horizontal { text-align: left; margin-top: 0px; }
    .history .dl-horizontal dt { width: 65px; margin-right: 5px; }
    .history .dl-horizontal dd { margin-left: 25px; }

    .comments { margin-bottom: 15px; }
    .comments > h3 { margin: 0; }
    .comments > hr { margin: 0 0 5px; }
    .comments > div { text-align: center; }
    .comments h4 { margin: 0 0 5px; }
    .comments .dl-horizontal { text-align: left; margin-top: 0px; }
    .comments .dl-horizontal dt { width: 65px; margin-right: 5px; }
    .comments .dl-horizontal dd { margin-left: 25px; }

    #addMember { margin: 0; }
    #addMember .controls { margin-left: 0; }
    #addMember .subGroup { margin-left: 0; }
    #addMember label { text-align: left; width: 35%; }
    #addMember .input { width: auto; }
    #addMember .form-actions { padding: 10px 0 0 0; margin: 0; background-color: inherit; text-align: center; border: none; }
</style>

<div class="organization page-header">
    <h1>
        <?=$organization->label?>
        <?php if ($organization->canBeEdited) : ?>
        <div class="pull-right">
            <small>
                <a class="editOrganization btn btn-small btn-primary"
                   href="orga/organization/edit/idOrganization/<?=$organization->id?>/">
                    <i class="icon-cog icon-white"></i>
                    <?=__('UI', 'verb', 'edit')?>
                </a>
            </small>
        </div>
        <?php endif; ?>
        <!-- Temporaire, pour la démo et le choix des vues -->
        <div class="pull-right" style="margin: 0 25px;">
            <small>
                <a class="btn btn-small btn-info"
                   href="orga/cell/view/idCell/<?=$currentCell->id?>/">
                    <i class="icon-fire icon-white"></i>
                    Cellules classiques
                </a>
            </small>
            <small>
                <a class="btn btn-small btn-info disabled"
                   href="orga/cell/mixitup-view/idCell/<?=$currentCell->id?>/">
                    <i class="icon-fire icon-white"></i>
                    Cellules mixitup
                </a>
                <script>
                    $('a.disabled').on('click', function(e) {
                        e.preventDefault();
                        alert('En cours de développement !');
                    });
                </script>
            </small>
        </div>
    </h1>
</div>

<div class="row-fluid">

<div class="span9">

    <div class="currentCell well">
        <h2>
            <?php if ($currentCell->showInput) : ?>
            <a href="orga/cell/input/idCell/<?=$currentCell->id?>/fromIdCell/<?=$currentCell->id?>/" title="<?=__('Orga', 'view', 'viewInput')?>" class="withTooltip">
            <?php endif; ?>
            <?=$currentCell->extendedLabel?>
            <?php if ($currentCell->showInput) : ?>
            <small>
                <i class="icon-share-alt"></i>
                <?=__('Orga', 'view', 'inputLinkDetail')?>
            </small>
            </a>
            <?php endif; ?>
            <small class="cellActions">
                <a data-toggle="modal" href="#administrators<?=$currentCell->id?>" title="<?=__('Orga', 'view', 'viewAdministrators')?>" class="withTooltip"><i class="icon-envelope"></i></a>
                <?php if ($currentCell->showsUsers) : ?>
                <a data-toggle="modal" href="#users<?=$currentCell->id?>" title="<?=__('Orga', 'view', 'viewUsers')?>" class="withTooltip"><i class="icon-user"></i></a>
                <?php endif; ?>
                <?php if ($currentCell->showReports) : ?>
                <a data-toggle="modal" href="#reports<?=$currentCell->id?>" title="<?=__('Orga', 'view', 'viewReports')?>" class="withTooltip"><i class="icon-tasks"></i></a>
                <a data-toggle="modal" data-target="#exports<?=$currentCell->id?>" href="orga/cell/view-exports/idCell/<?=$currentCell->id?>/" title="<?=__('Orga', 'view', 'viewExports')?>" class="withTooltip"><i class="icon-download-alt"></i></a>
                <?php endif; ?>
            </small>
        </h2>
        <?php // Inventory ?>
        <?php if ($currentCell->showInventory) : ?>
        <div class="inventoryStatus">
            <b><?=__('Orga', 'inventory', 'inventoryStatus')?>&nbsp;:&nbsp;</b>
            <?php if ($currentCell->canEditInventory) : ?>
            <div class="btn-group">
                <button class="btn dropdown-toggle btn-<?=$currentCell->inventoryStatusStyle?>" data-toggle="dropdown" data-inventory="<?=$currentCell->inventoryStatus?>">
                    <i class="icon-edit icon-white"></i>
                    <?=$currentCell->inventoryStatusTitle?>
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <?php foreach ($cellVWFactory->inventoryStatusList as $inventoryStatusValue => $inventoryStatusLabel) : ?>
                    <li>
                        <a href="orga/cell/edit-inventory-status/idCell/<?=$currentCell->id?>/" data-inventory="<?=$inventoryStatusValue?>">
                            <?=$inventoryStatusLabel?>
                        </a>
                    </li>
                    <?php endforeach; ?>
                </ul>
            </div>
            <?php else: ?>
                <span class="label label-<?=$currentCell->inventoryStatusStyle?>">
                <?=$currentCell->inventoryStatusTitle?>
            </span>
            <?php endif; ?>
            <a href="#" class="withPopover inventoryInputsDetails" title="<?=__('Orga', 'view', 'inventoryInputsDetails')?>"
               data-toggle="tooltip" data-placement="bottom" data-trigger="hover" data-html="true"
               data-content="<?=$currentCell->inventoryNotStartedInputsNumber?> <?=($currentCell->inventoryNotStartedInputsNumber > 1) ? __('Orga', 'view', 'inputsNotStartedMany') : __('Orga', 'view', 'inputsNotStartedSingle')?> <br> <?=$currentCell->inventoryStartedInputsNumber?> <?=($currentCell->inventoryStartedInputsNumber > 1) ? __('Orga', 'view', 'inputsStartedMany') : __('Orga', 'view', 'inputsStartedSingle')?> <br> <?=$currentCell->inventoryCompletedInputsNumber?> <?=($currentCell->inventoryCompletedInputsNumber > 1) ? __('Orga', 'view', 'inputsCompletedMany') : __('Orga', 'view', 'inputsCompletedSingle')?>">
                <i class="icon-info-sign"></i>
            </a>
        </div>
        <div class="progress">
            <div class="bar" style="width: <?=$currentCell->inventoryCompletion?>%">
                <?=$currentCell->inventoryCompletion?> %
            </div>
        </div>
        <?php endif; ?>
        <?php // Input ?>
        <?php if ($currentCell->showInput) : ?>
        <div class="inputStatus">
            <b><?=__('Orga', 'input', 'inputStatus')?>&nbsp;:&nbsp;</b>
            <span class="badge badge-<?=$currentCell->inputStatusStyle?>">
                <?=$currentCell->inputStatusTitle?>
            </span>
        </div>
        <div class="progress progress-<?=$currentCell->inputStatusStyle?>">
            <div class="bar" style="width: <?=$currentCell->inputCompletion?>%"><?=$currentCell->inputCompletion?> %</div>
        </div>
        <?php endif; ?>

        <div id="administrators<?=$currentCell->id?>" class="modal administrators hide fade">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4><?=__('Orga', 'view', 'administratorsFrom')?> <?=$currentCell->shortLabel?></h4>
            </div>
            <div class="modal-body">
                <pre><?=implode("\n", $currentCell->administrators)?></pre>
            </div>
        </div>
        <?php if ($currentCell->showsUsers) : ?>
        <div id="users<?=$currentCell->id?>" class="modal users hide fade large" data-cell="<?=$currentCell->id?>">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4><?=__('Orga', 'view', 'usersFrom')?> <?=$currentCell->shortLabel?></h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <form class="form-inline addUser" action="orga/cell/add-user/idCell/<?=$currentCell->id?>/">
                    <input type="text" name="userEmail" placeholder="<?=__('Orga', 'view', 'userEmailPlaceholder')?>">
                    <select name="userRole">
                        <option value="CellAdminRole"><?=CellAdminRole::getLabel()?></option>
                        <option value="CellManagerRole"><?=CellManagerRole::getLabel()?></option>
                        <option value="CellContributorRole"><?=CellContributorRole::getLabel()?></option>
                        <option value="CellObserverRole"><?=CellObserverRole::getLabel()?></option>
                    </select>
                    <button type="submit" class="btn btn-primary">
                        <i class="icon-plus icon-white"></i>
                        <?=__('Orga', 'view', 'addUser')?>
                    </button>
                </form>
            </div>
        </div>
        <?php endif; ?>
        <?php if ($currentCell->showReports) : ?>
        <div id="reports<?=$currentCell->id?>" class="modal reports hide fade large" data-cell="<?=$currentCell->id?>">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4><?=__('Orga', 'view', 'reportsFrom')?> <?=$currentCell->shortLabel?></h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <a href="orga/cell/view-report/idCell/<?=$currentCell->id?>/" class="btn btn-primary">
                    <i class="icon-plus icon-white"></i>
                    <?=__('Orga', 'view', 'addReport')?>
                </a>
            </div>
        </div>
        <div id="exports<?=$currentCell->id?>" class="modal exports hide fade">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4><?=__('Orga', 'view', 'exportsFrom')?> <?=$currentCell->shortLabel?></h4>
            </div>
            <div class="modal-body">
                <div class="granularityCells row-fluid">
                    <img src="images/ui/ajax-loader_large.gif">
                    <?=__('Orga', 'view', 'loadingExports')?>
                </div>
            </div>
        </div>
        <?php endif; ?>
    </div>

    <?php foreach ($this->narrowerGranularities as $narrowerGranularityArray) :
    /** @var Orga_Model_Granularity $narrowerGranularity */
    $narrowerGranularity = $narrowerGranularityArray['granularity'];
    ?>
    <fieldset class="wrapper granularityWrapper">
        <legend data-toggle="collapse" data-target="#granularity<?=$narrowerGranularity->getId()?>">
            <i class="filterChevron icon-chevron-<?=((count($this->narrowerGranularities) === 1)?'down':'right')?>"></i>
            <?=$narrowerGranularityArray['purpose']?>
            <small>
                <?=$narrowerGranularity->getLabel()?>
            </small>
        </legend>

        <div id="granularity<?=$narrowerGranularity->getId()?>"
            <?=$narrowerGranularityArray['isAcl'] ? ' data-acl' : ''?>
            <?=$narrowerGranularityArray['isInventory'] ? ' data-inventory' : ''?>
            <?=$narrowerGranularityArray['isInput'] ? ' data-input' : ''?>
            <?=$narrowerGranularityArray['isAnalyses'] ? ' data-analyses' : ''?>
             class="collapse<?=((count($this->narrowerGranularities) === 1)?' in':'')?>">
            <?php if ($narrowerGranularity->hasAxes() || ($narrowerGranularity->getInputConfigGranularity() !== null)) : ?>
            <form class="form-inline cells-filter">
                <?php foreach ($narrowerGranularityArray['filterAxes'] as $memberOptions) : ?>
                <?php if (count($memberOptions) > 2) : ?>
                <select data-filter="tag">
                    <?php foreach ($memberOptions as $memberTag => $memberLabel) : ?>
                    <option value="<?=$memberTag?>"><?=$memberLabel?></option>
                    <?php endforeach; ?>
                </select>
                <?php endif; ?>
                <?php endforeach; ?>
                <?php if ($narrowerGranularityArray['isInput']) : ?>
                <select data-filter="input-status">
                    <?php foreach ($inputStatusFilters as $statusValue => $statusLabel) : ?>
                    <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                    <?php endforeach; ?>
                </select>
                <?php endif; ?>
                <?php if ($narrowerGranularityArray['isInventory']) : ?>
                <select data-filter="inventory-status">
                    <?php foreach ($inventoryStatusFilters as $statusValue => $statusLabel) : ?>
                        <? if (($statusValue === Orga_Model_Cell::STATUS_ACTIVE) && (!$narrowerGranularityArray['isGranularityForInventoryStatus'])) : ?>
                    <option value="<?=$statusValue?>" selected><?=$statusLabel?></option>
                    <?php else: ?>
                    <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                    <?php endif ?>
                    <?php endforeach ?>
                </select>
                <?php endif; ?>
                <button class="btn reset"><i class="icon-zoom-out"></i> Reset</button>
                <span class="badge badge-info granularityInfo"></span>
            </form>
            <?php endif; ?>

            <table class="granularity table table-hover table-condensed" data-total-cells="" data-displayed-cells="12">
            </table>
        </div>
    </fieldset>
    <?php endforeach; ?>

</div>

<div class="span3">
    <div class="comments">
        <h3>
            <?=__('Orga', 'view', 'comments')?>
            <small class="pull-right">
                <a href="orga/cell/view-comments/idCell/<?=$currentCell->id?>/" class="refresh">
                    <i class="icon-refresh"></i>
                </a>
            </small>
        </h3>
        <hr/>
        <div>
            <?=__('Orga', 'view', 'notLoadedComments')?>
        </div>
    </div>
    <div class="history">
        <h3>
            <?=__('UI', 'history', 'history')?>
            <small class="pull-right">
                <a href="orga/cell/view-history/idCell/<?=$currentCell->id?>/" class="refresh">
                    <i class="icon-refresh"></i>
                </a>
            </small>
        </h3>
        <hr/>
        <div>
            <?=__('Orga', 'view', 'notLoadedHistory')?>
        </div>
    </div>
    <?php if ($organization->canBeEdited) : ?>
    <div class="addMember">
        <h3>
            <?=__('Orga', 'view', 'addMember')?>
            <div class="pull-right">
                <small>
                    <a class="editOrganization btn btn-small btn-primary"
                       href="orga/organization/edit/idOrganization/<?=$organization->id?>/tab/members/">
                        <i class="icon-cog icon-white"></i>
                        <?=__('UI', 'verb', 'edit')?>
                    </a>
                </small>
            </div>
        </h3>
        <hr/>
        <?=$this->addMembersForm->display()?>
    </div>
    <?php endif; ?>
</div>

</div>
<script>
$('.history a.refresh').on('click', function(e) {
    e.preventDefault();
    $('.history > div').html('<img src="images/ui/ajax-loader_large.gif"> <?=addslashes(__('UI', 'history', 'loadingHistory'))?>');
    $.ajax({
        url: $(this).attr('href'),
        type: "GET",
        success: function(data) {
            $('.history > div').html('');
            if (data.length > 0) {
                $.each(data, function() {
                    var date = this.date;
                    $('.history > div').append('<div data-date="' + date + '"><h4 class="label">' + date + '</h4></div>');
                    var divDate = $('.history > div > div[data-date="' + date + '"]');
                    divDate.append('<dl class="dl-horizontal"></dl>');
                    var dlDate = $('dl', divDate);
                    $.each(this.events, function() {
                        dlDate.append('<dt><span class="badge badge-info">' + this.time + '</span></dt>');
                        dlDate.append('<dd>' + this.event + '</dd>');
                    });
                });
            } else {
                $('.history > div').html('<p><?=__('UI', 'history', 'noHistory')?></p>');
            }
        },
        error: function(jqXHR) {
            $('.history > div').html('<?=addslashes(__('UI', 'history', 'errorWhileLoadingHistory'))?>');
        }
    });
});
$('.comments a.refresh').on('click', function(e) {
    e.preventDefault();
    $('.comments > div').html('<img src="images/ui/ajax-loader_large.gif"> <?=addslashes(__('UI', 'comment', 'loadingComments'))?>');
    $.ajax({
        url: $(this).attr('href'),
        type: "GET",
        success: function(data) {
            $('.comments > div').html('');
            if (data.length > 0) {
                $.each(data, function() {
                    var date = this.date;
                    $('.comments > div').append('<div data-date="' + date + '"><h4 class="label">' + date + '</h4></div>');
                    var divDate = $('.comments > div > div[data-date="' + date + '"]');
                    divDate.append('<dl class="dl-horizontal"></dl>');
                    var dlDate = $('dl', divDate);
                    $.each(this.comments, function() {
                        dlDate.append('<dt><span class="badge badge-info">' + this.time + '</span></dt>');
                        dlDate.append('<dd>' + this.comment + '</dd>');
                    });
                });
            } else {
                $('.comments > div').html('<p><?=addslashes(__('UI', 'comment', 'noComment'))?></p>');
            }
        },
        error: function(jqXHR) {
            $('.comments > div').html('<?=addslashes(__('UI', 'comment', 'errorWhileLoadingComments'))?>');
        }
    });
});

$('.granularityWrapper > div').on('show', function(e) {
    if (e.currentTarget == e.target) {
        $('legend > i.filterChevron', $(this).parent()).removeClass('icon-chevron-right');
        $('legend > i.filterChevron', $(this).parent()).addClass('icon-chevron-down');
    }
});
$('.granularityWrapper > div').on('hidden', function(e) {
    if (e.currentTarget == e.target) {
        $('legend > i.filterChevron', $(this).parent()).removeClass('icon-chevron-down');
        $('legend > i.filterChevron', $(this).parent()).addClass('icon-chevron-right');
    }
});

$('div.collapse[id^="granularity"]').on('loadCells', function(e) {
    if (e.target != this) {
        return;
    }
    var granularity = $('.granularity', $(this));
    if (!granularity.attr('data-initialized')) {
        var granularityInfo = $('.granularityInfo', granularity.parent());
        granularityInfo[0].className = granularityInfo[0].className.replace(/\bbadge-.*?\b/g, '');
        granularityInfo.addClass('badge-info');
        granularityInfo.html('<?=__('Orga', 'view', 'loadingCells')?>');
        granularityInfo.after(' <img class="granularityLoading" src="images/ui/ajax-loader.gif">');
        var granularityId = $(this).attr('id').substr(11, $(this).attr('id').length);
        $.ajax({
            url: 'orga/cell/view-children/idCell/<?=$currentCell->id?>/idGranularity/' + granularityId + '/',
            type: "GET",
            success: function(data) {
                granularity.html('');
                granularity.attr('data-total-cells', data.totalCells);
                $(data.childCells).each(function() {
                    var cellTitle = this.extendedLabel;
                    if (this.showInput) {
                        cellTitle = '<a href="orga/cell/input/idCell/' + this.id + '/fromIdCell/<?=$currentCell->id?>/" title="<?=__('Orga', 'view', 'viewInput')?>" class="withTooltip">' +
                            cellTitle +
                            '<small>' +
                            ' <i class="icon-share-alt"></i> ' +
                            '<?=__('Orga', 'view', 'inputLinkDetail')?>' +
                            '</small>' +
                        '</a>';
                    }
                    var usersP = '';
                    var usersPopup = '';
                    if (this.showUsers) {
                        usersP +=
                            '<a data-toggle="modal" href="#users' + this.id + '" title="<?=__('Orga', 'view', 'viewUsers')?>" class="withTooltip">' +
                                '<i class="icon-user"></i>' +
                            '</a>';
                        usersPopup +=
                            '<div id="users' + this.id + '" class="modal users hide fade large" data-cell="' + this.id + '">' +
                                '<div class="modal-header">' +
                                    '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                    '<h4><?=__('Orga', 'view', 'usersFrom')?> ' + this.shortLabel + '</h4>' +
                                '</div>' +
                                '<div class="modal-body">' +
                                '</div>' +
                                '<div class="modal-footer">' +
                                    '<form class="form-inline addUser" action="orga/cell/add-user/idCell/' + this.id + '/">' +
                                        '<input type="text" placeholder="<?=__('Orga', 'view', 'userEmailPlaceholder')?>" name="userEmail"> ' +
                                        '<select name="userRole">' +
                                            '<option value="CellAdminRole"><?=CellAdminRole::getLabel()?></option>' +
                                            '<option value="CellManagerRole"><?=CellManagerRole::getLabel()?></option>' +
                                            '<option value="CellContributorRole"><?=CellContributorRole::getLabel()?></option>' +
                                            '<option value="CellObserverRole"><?=CellObserverRole::getLabel()?></option>' +
                                        '</select> ' +
                                        '<input type="submit" class="btn btn-primary" value="<?=__('Orga', 'view', 'addUser')?>"> ' +
                                    '</form>' +
                                '</div>' +
                            '</div>';
                    }
                    var reportsP = '';
                    var reportsPopup = '';
                    if (this.showReports) {
                        reportsP +=
                            '<a data-toggle="modal" href="#reports' + this.id + '" title="<?=__('Orga', 'view', 'viewReports')?>" class="withTooltip">' +
                                '<i class="icon-tasks"></i>' +
                            '</a>';
                        reportsPopup +=
                            '<div id="reports' + this.id + '" class="modal reports hide fade large" data-cell="' + this.id + '">' +
                                '<div class="modal-header">' +
                                    '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                    '<h4><?=__('Orga', 'view', 'reportsFrom')?>' + this.shortLabel + '</h4>' +
                                '</div>' +
                                '<div class="modal-body">' +
                                '</div>' +
                                '<div class="modal-footer">' +
                                    '<a href="orga/cell/view-report/idCell/' + this.id + '/" class="btn btn-primary">' +
                                        '<i class="icon-plus icon-white"></i> ' +
                                        '<?=__('Orga', 'view', 'addReport')?>' +
                                    '</a>' +
                                '</div>' +
                            '</div>';
                    }
                    var exportsP = '';
                    var exportsPopup = '';
                    if (this.showExports) {
                        exportsP +=
                            '<a data-toggle="modal" data-target="#exports' + this.id + '" href="orga/cell/view-exports/idCell/' + this.id + '/" title="<?=__('Orga', 'view', 'viewExports')?>" class="withTooltip">' +
                                '<i class="icon-download-alt"></i>' +
                            '</a>';
                        exportsPopup +=
                            '<div id="exports' + this.id + '" class="modal exports hide fade">' +
                                '<div class="modal-header">' +
                                    '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                    '<h4><?=__('Orga', 'view', 'exportsFrom')?> ' + this.shortLabel + '</h4>' +
                                '</div>' +
                                '<div class="modal-body">' +
                                    '<img src="images/ui/ajax-loader_large.gif"> ' +
                                    '<?=__('Orga', 'view', 'loadingExports')?>' +
                                '</div>' +
                            '</div>';
                    }
                    var inventoryP = '';
                    if (this.showInventory) {
                        inventoryP +=
                            '<div class="inventoryStatus">' +
                                '<b><?=__('Orga', 'inventory', 'inventoryStatus')?>&nbsp;:&nbsp;</b>';
                        if (this.canEditInventory) {
                            inventoryP +=
                                '<div class="btn-group">' +
                                    '<button class="btn dropdown-toggle btn-' + this.inventoryStatusStyle + '" data-toggle="dropdown" data-inventory="' + this.inventoryStatus + '">' +
                                        '<i class="icon-edit icon-white"></i> ' +
                                        this.inventoryStatusTitle +
                                        ' <span class="caret"></span>' +
                                    '</button>' +
                                    '<ul class="dropdown-menu">' +
                                        <?php foreach ($cellVWFactory->inventoryStatusList as $inventoryStatusValue => $inventoryStatusLabel) : ?>
                                        '<li>' +
                                            '<a href="orga/cell/edit-inventory-status/idCell/' + this.id + '/" data-inventory="<?=$inventoryStatusValue?>">' +
                                                '<?=$inventoryStatusLabel?>' +
                                            '</a>' +
                                        '</li>' +
                                        <?php endforeach; ?>
                                    '</ul>' +
                                '</div>';
                        } else {
                            inventoryP +=
                                '<span class="label label-' + this.inventoryStatusStyle + '">' +
                                    this.inventoryStatusTitle +
                                '</span>';
                        }
                        inventoryP +=
                                ' <a href="#" class="withPopover inventoryInputsDetails" title="<?=__('Orga', 'view', 'inventoryInputsDetails')?>"' +
                                'data-toggle="tooltip" data-placement="bottom" data-trigger="hover" data-html="true"' +
                                'data-content="' +
                                this.inventoryNotStartedInputsNumber + ' ' +
                                ((this.inventoryNotStartedInputsNumber > 1) ? '<?=__('Orga', 'view', 'inputsNotStartedMany')?>' : '<?=__('Orga', 'view', 'inputsNotStartedSingle')?>') +
                                ' <br> ' +
                                this.inventoryStartedInputsNumber + ' ' +
                                ((this.inventoryStartedInputsNumber > 1) ? '<?=__('Orga', 'view', 'inputsStartedMany')?>' : '<?=__('Orga', 'view', 'inputsStartedSingle')?>') +
                                ' <br> ' +
                                this.inventoryCompletedInputsNumber + ' ' +
                                ((this.inventoryCompletedInputsNumber > 1) ? '<?=__('Orga', 'view', 'inputsCompletedMany')?>' : '<?=__('Orga', 'view', 'inputsCompletedSingle')?>') +
                                '">' +
                                    '<i class="icon-info-sign"></i>' +
                                '</a>' +
                            '</div>' +
                            '<div class="progress">' +
                                '<div class="bar" style="width: ' + this.inventoryCompletion + '%">' + this.inventoryCompletion + '%</div>' +
                            '</div>';
                    }
                    var inputStatusP = '';
                    if (this.showInput) {
                        inputStatusP =
                            '<div class="inputStatus">' +
                                '<b><?=__('Orga', 'input', 'inputStatus')?>&nbsp;:&nbsp;</b>' +
                                '<span class="badge badge-' + this.inputStatusStyle + '">' +
                                    this.inputStatusTitle +
                                '</span>' +
                            '</div>' +
                            '<div class="progress progress-' + this.inputStatusStyle + '">' +
                                '<div class="bar" style="width: ' + this.inputCompletion + '%">' + this.inputCompletion + ' %</div>' +
                            '</div>';
                    }
                    granularity.append(
                        '<tr class="cell hide" data-tag="' + this.tag + '" data-input-status="' + this.inputStatus + '" data-inventory-status="' + this.inventoryStatus + '">' +
                            '<td>' +
                            cellTitle +
                            '</td>' +
                            '<td>' +
                            usersP +
                            reportsP +
                            exportsP +
                            '</td>' +
                            '<td>' +
                            inventoryP +
                            '</td>' +
                            '<td>' +
                            inputStatusP +
                            '</td>' +
                        '</tr>'
                    );
                    granularity.after(usersPopup + reportsPopup + exportsPopup);
                });
                $('.withTooltip', granularity).tooltip();
                $('.withPopover', granularity).popover();
                $('.granularityLoading', granularityInfo.parent()).remove();
                $('select:first', granularity.parent()).trigger('filterCells');
            },
            error: function(jqXHR) {
                granularityInfo[0].className = granularityInfo[0].className.replace(/\bbadge-.*?\b/g, '');
                $('.granularityLoading', granularityInfo.parent()).remove();
                var response = $.parseJSON(jqXHR.responseText);
                if (typeof(response.typeError) == 'string') {
                    granularityInfo.addClass('badge-' + response.typeError);
                } else {
                    granularityInfo.addClass('badge-error');
                }
                if (typeof(response.message) == 'string') {
                    granularityInfo.html(response.message);
                } else {
                    granularityInfo.html('<?=__('Orga', 'view', 'errorWhileLoadingChildCells')?>');
                }
            }
        });
    }
});

$('.cells-filter button.reset').on('click', function(e) {
    e.preventDefault();
    var form = $(this).parent();
    form.trigger('resetCellsFilter');
    form.trigger('filterCells');
});
$('.cells-filter').on('resetCellsFilter', function(e) {
    e.preventDefault();
    var form = $(this).parent();
    $('select', form).each(function() { $(this).val(''); });
    $('select:first', form).trigger('change');
});
$('.cells-filter select').on('keyup change', function(e) {
    var form = $(this).parent();
    var granularity = $('.granularity', form.parent());
    granularity.attr('data-displayed-cells', 12);
    form.trigger('filterCells');
});
$('.cells-filter').on('filterCells', function(e) {
    e.preventDefault();
    var form = $(this);
    var granularity = $('.granularity', form.parent());

    $('.displayMoreCells', granularity.parent()).remove();
    $('.cell:not(.hide)', granularity).addClass('hide');

    var test = '';
    $('select', form).each(function() {
        var filter = $(this).attr('data-filter');
        var value = $(this).val();
        if ((filter == 'input-status') && (value == 'notStarted')) {
            test += '[data-' + filter + '=\'null\']';
        } else if (value != '') {
            if (filter == 'tag') {
                test += '[data-' + filter + '*=\'' + value + '\']';
            } else {
                test += '[data-' + filter + '=\'' + value + '\']';
            }
        }
    });

    var displayedCells = granularity.attr('data-displayed-cells');
    var numberElement = 0;
    $('.cell' + test, granularity).each(function() {
        var cell = $(this);
        cell.removeClass('hide');

        numberElement++;
        if (numberElement > (displayedCells - 1)) {
            return false;
        }
    });

    var granularityInfo = $('.granularityInfo', form);
    granularityInfo.html(numberElement + ' / ' + granularity.attr('data-total-cells'));

    if ($('.cell' + test, granularity).length > numberElement) {
        granularity.after(
            '<div class="btn btn-primary span displayMoreCells">' +
                '<?=__('Orga', 'view', 'displayMoreCells')?>' +
            '</div>'
        );
    }
});
$('body').on('click', '.displayMoreCells', function (e) {
    var granularity = $('.granularity', $(this).parent());
    granularity.attr('data-displayed-cells', (granularity.attr('data-displayed-cells') * 1 + 18));
    $('.cells-filter', granularity.parent()).trigger('filterCells');
});

$('body').on('show', '.users', function(e) {
    if (e.target != this) {
        return;
    }
    var popup = $(this);
    $('.modal-body', popup).html(
        '<img src="images/ui/ajax-loader_large.gif"> <?=__('Orga', 'view', 'loadingUsers')?>'
    );
    $.ajax({
        url: 'orga/cell/view-users/idCell/' + popup.attr('data-cell') + '/',
        type: "GET",
        success: function(data) {
            $('.modal-body', popup).html(data);
        },
        error: function(jqXHR) {
            $('.modal-body', popup).html('<?=__('Orga', 'view', 'errorWhileLoadingUsers')?>');
        }
    });
});
$('body').on('hidden', '.users', function(e) {
    if (e.target != this) {
        return;
    }
    var popup = $(this);
    $('.userMessage', popup).remove();
    $('.modal-footer form input[name="userEmail"]', popup).val('');
});
$('body').on('click', '.deleteUser', function(e) {
    e.preventDefault();
    if ($(this).attr('data-submitting') === 'true') {
        return false;
    }
    $('.userMessage').remove();
    $(this).parent().parent().after(
        '<tr class="info userMessage">' +
            '<td colspan="5">' +
                '<?=__('Orga', 'view', 'askConfirmDeleteUser')?>' +
                $(this).parent().prev().prev().html() +
                '<button class="btn btn-primary confirm"><i class="icon-ok icon-white"></i> <?=__('Orga', 'view', 'confirmDeleteUser')?></button>' +
                '<button class="btn closeUserMessage"><i class="icon-remove"></i> <?=__('Orga', 'view', 'confirmDeleteUser')?></button>' +
            '</td>' +
        '</tr>'
    );
});
$('body').on('click', 'tr.userMessage .confirm', function(e) {
    e.preventDefault();
    var row = $(this).parent().parent();
    var deleteUser = $('.deleteUser', row.prev());
    if (deleteUser.attr('data-submitting') === 'true') {
        return false;
    }
    deleteUser.attr('data-submitting', true);
    row.html('<td colspan="5"><img src="images/ui/ajax-loader.gif"></td>');
    $.ajax({
        url: $('a.deleteUser', row.prev()).attr('href'),
        type: "POST",
        success: function(data) {
            row.prev().remove();
            row.removeClass('info');
            row.addClass('success');
            row.html(
                '<td colspan="4">' + data + '</td>' +
                '<td><button class="close closeUserMessage"><i class="icon-remove"></i></button></td>'
            );
        },
        error: function(jqXHR) {
            deleteUser.attr('data-submitting', false);
            row.removeClass('info');
            var response = $.parseJSON(jqXHR.responseText);
            if (typeof(response.typeError) == 'string') {
                row.addClass(response.typeError);
            } else {
                row.addClass('error');
            }
            if (typeof(response.message) == 'string') {
                row.html(
                    '<td colspan="4">' + response.message + '</td>' +
                    '<td><button class="close closeUserMessage"><i class="icon-remove"></i></button></td>'
                );
            } else {
                row.html(
                    '<td colspan="4"><?=__('Orga', 'view', 'errorWhileDeletingUser')?></td>' +
                    '<td><button class="close closeUserMessage"><i class="icon-remove"></i></button></td>'
                );
            }
        }
    });
});
$('body').on('click', 'tr.userMessage .closeUserMessage', function(e) {
    e.preventDefault();
    $(this).parent().parent().remove();
});
$('body').on('submit', '.addUser', function(e) {
    e.preventDefault();
    var form = $(this);
    if (form.attr('data-submitting') === 'true') {
        return false;
    }
    form.attr('data-submitting', true);
    $('.userMessage').remove();
    form.before('<div class="userMessage alert alert-info"><img src="images/ui/ajax-loader.gif"></div>')
    $.ajax({
        url: form.attr('action'),
        type: "POST",
        data: form.serialize(),
        success: function(data) {
            form.prev().removeClass('alert-info');
            form.prev().addClass('alert-success');
            form.prev().html(data);
            form.parent().parent().trigger('show');
            form.attr('data-submitting', false);
        },
        error: function(jqXHR) {
            form.prev().removeClass('alert-info');
            var response = $.parseJSON(jqXHR.responseText);
            if (typeof(response.typeError) == 'string') {
                form.prev().addClass('alert-' + response.typeError);
            } else {
                form.prev().addClass('alert-error');
            }
            if (typeof(response.message) == 'string') {
                form.prev().html(response.message);
            } else {
                form.prev().html('<?=__('Orga', 'view', 'errorWhileAddingUser')?>');
                form.attr('data-submitting', false);
            }
        }
    });
});

$('body').on('show', '.reports', function(e) {
    if (e.target != this) {
        return;
    }
    var popup = $(this);
    $('.modal-body', popup).html(
        '<img src="images/ui/ajax-loader_large.gif"> <?=__('Orga', 'view', 'loadingReports')?>'
    );
    $.ajax({
        url: 'orga/cell/view-reports/idCell/' + popup.attr('data-cell') + '/',
        type: "GET",
        success: function(data) {
            $('.modal-body', popup).html(data);
        },
        error: function(jqXHR) {
            $('.modal-body', popup).html('<?=__('Orga', 'view', 'errorWhileLoadingReports')?>');
        }
    });
});
$('body').on('hidden', '.reports', function(e) {
    if (e.target != this) {
        return;
    }
    var popup = $(this);
    $('.reportMessage', popup).remove();
});
$('body').on('click', '.deleteReport', function(e) {
    e.preventDefault();
    if ($(this).attr('data-submitting') === 'true') {
        return false;
    }
    $('.reportMessage').remove();
    $(this).parent().parent().after(
        '<tr class="info reportMessage">' +
            '<td colspan="3">' +
                '<?=__('Orga', 'view', 'askConfirmDeleteReport')?>' +
                $('a', $(this).parent().prev().prev()).html() +
                '<button class="btn btn-primary confirm"><i class="icon-ok icon-white"></i> <?=__('Orga', 'view', 'confirmDeleteReport')?></button>' +
                '<button class="btn closeReportMessage"><i class="icon-remove"></i> <?=__('Orga', 'view', 'cancelDeleteReport')?></button>' +
            '</td>' +
        '</tr>'
    );
});
$('body').on('click', 'tr.reportMessage .confirm', function(e) {
    e.preventDefault();
    var row = $(this).parent().parent();
    var deleteReport = $('.deleteReport', row.prev());
    if (deleteReport.attr('data-submitting') === 'true') {
        return false;
    }
    deleteReport.attr('data-submitting', true);
    row.html('<td colspan="3"><img src="images/ui/ajax-loader.gif"></td>');
    $.ajax({
        url: $('a.deleteReport', row.prev()).attr('href'),
        type: "POST",
        success: function(data) {
            row.prev().remove();
            row.removeClass('info');
            row.addClass('success');
            row.html(
                '<td colspan="2">' + data + '</td>' +
                '<td><button class="close closeReportMessage"><i class="icon-remove"></i></button></td>'
            );
        },
        error: function(jqXHR) {
            deleteReport.attr('data-submitting', false);
            row.removeClass('info');
            var response = $.parseJSON(jqXHR.responseText);
            if (typeof(response.typeError) == 'string') {
                row.addClass(response.typeError);
            } else {
                row.addClass('error');
            }
            if (typeof(response.message) == 'string') {
                row.html(
                    '<td colspan="2">' + response.message + '</td>' +
                    '<td><button class="close closeReportMessage"><i class="icon-remove"></i></button></td>'
                );
            } else {
                row.html(
                    '<td colspan="2"><?=__('Orga', 'view', 'errorWhileDeletingReport')?></td>' +
                    '<td><button class="close closeReportMessage"><i class="icon-remove"></i></button></td>'
                );
            }
        }
    });
});
$('body').on('click', 'tr.reportMessage .closeReportMessage', function(e) {
    e.preventDefault();
    $(this).parent().parent().remove();
});

$('body').on('click', '.inventoryStatus .dropdown-menu a', function(e) {
    e.preventDefault();
    var link = $(this);
    var button = link.parent().parent().prev();
    if (link.attr('data-inventory') != button.attr('data-inventory')) {
        button.html('<img src="images/ui/ajax-loader.gif">');
        button.attr('class', 'btn dropdown-toggle');
        $.ajax({
            url: link.attr('href'),
            type: "POST",
            data: { inventoryStatus: link.attr('data-inventory') },
            success: function (data) {
                var oldInventoryValue = button.attr('data-inventory');
                button.attr('data-inventory', data.status);
                button.addClass('btn-' + data.style);
                button.html('<i class="icon-edit icon-white"></i> ' + data.label + ' <span class="caret"></span>');
                button.parent().parent().parent().attr('data-inventory-status', data.status);
                var collapse = button.parent().parent().parent().parent().parent().parent().parent().parent();
                $('select:first', collapse).trigger('change');
                $('.collapse[data-inventory][id!="' + collapse.attr('id') + '"]').each(function() {
                    var filterInventoryValue = $('select[data-filter="inventory-status"]', $(this)).val();
                    if ((filterInventoryValue == oldInventoryValue) || (filterInventoryValue == data.status)) {
                        $(this).trigger('loadCells');
                    }
                });
            },
            error: function (jqXHR) {
                button.attr('data-inventory', null);
                var response = $.parseJSON(jqXHR.responseText);
                if ((typeof(response.typeError) == 'string') && (response.typeError != 'error')) {
                    button.addClass('btn-' + response.typeError);
                } else {
                    button.addClass('btn-danger');
                }
                if (typeof(response.message) == 'string') {
                    button.html(response.message + ' <span class="caret"></span>');
                } else {
                    button.html('<?=__('Orga', 'view', 'errorWhileEditingInventoryStatus')?> <span class="caret"></span>');
                }
            }
        });
    }
});

$('.collapse').on({
    shown: function(e) {
        if (e.target == this) { $(this).css('overflow','visible');
        }
    },
    hide: function(e) {
        if (e.target == this) {
            $(this).css('overflow','hidden');
        }
    }
});
$('body').on('click', 'a.inventoryInputsDetails', function(e) {
    e.preventDefault();
});

$(document).ready(function() {
    $('.withTooltip').tooltip();
    $('.withPopover').popover();
    $('div.collapse[id^="granularity"]').trigger('loadCells');
    $('.history .icon-refresh').trigger('click');
    $('.comments .icon-refresh').trigger('click');
});
</script>
