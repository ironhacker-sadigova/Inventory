<?php
use Parameter\Application\Form\AddNodeForm;
use Parameter\Domain\Category;
use Parameter\Domain\ParameterLibrary;

/** @var ParameterLibrary $library */
$library = $this->library;
?>

<div class="page-header">
    <h1>
        <?=$library->getLabel()?>
        <small><?=__('Parameter', 'familyList', 'familyList')?></small>
    </h1>
</div>

<?php
$datagrid = new UI_Datagrid('familyDatagrid', 'datagrid_family-datagrid', 'parameter');
$datagrid->addParam('library', $library->getId());

$columns = [];

$columns['category'] = new UI_Datagrid_Col_List('category', __('UI', 'name', 'category'));
$list = [];
/** @var $categories Category[] */
$categories = Category::loadList();
foreach ($categories as $category) {
    $list[$category->getId()] = $category->getLabel();
}
$columns['category']->list = $list;
$columns['category']->fieldType = UI_Datagrid_Col_List::FIELD_LIST;
$columns['category']->addable = true;

$columns['label'] = new UI_Datagrid_Col_Text('label', __('UI', 'name', 'label'));
$columns['label']->addable = true;

$columns['ref'] = new UI_Datagrid_Col_Text('ref', __('UI', 'name', 'identifier'));
$columns['ref']->addable = true;

$columns['unit'] = new UI_Datagrid_Col_Text('unit', __('Unit', 'name', 'unit'));
$columns['unit']->addable = true;

$columns['detail'] = new UI_Datagrid_Col_Link('detail', __('UI', 'name', 'details'));
$columns['detail']->addable = false;

foreach ($columns as $column) {
    $column->editable = false;
    $datagrid->addCol($column);
}

if ($this->edit) {
    $datagrid->addElements = true;
    $datagrid->addPanelTitle = __('Parameter', 'familyList', 'addPanelTitle');
}

$datagrid->display();


$tree = new UI_Tree('familyTree', 'tree_family-tree', 'parameter');
$tree->addParam('library', $library->getId());
$tree->expandAll = false;
$tree->collapseAll = false;

if ($this->edit) {
    // Ajout.
    $tree->addNode = true;
    $addForm = new AddNodeForm('addNode');
    $tree->addPanelForm = $addForm;
    $tree->addPanelTitle = __('Parameter', 'familyTree', 'addCategoryPopupTitle');
    $tree->addButtonLabel = __('Parameter', 'familyTree', 'addCategoryButton');
    // Ã‰dition.
    $editLabel = new UI_Form_Element_Text('familyTree_labelEdit');
    $editLabel->setLabel(__('UI', 'name', 'label'));
    $htmlComplement = new UI_Form_Element_HTML('familyTree_htmlComplement');
    $htmlComplement->setLabel('');
    $tree->setEditNode(true, true, [$editLabel, $htmlComplement]);
    $tree->editPanelTitle = __('Parameter', 'familyTree', 'editCategoryPopupTitle');
    // Suppression.
    $tree->deleteNode = true;
}

$tree->display();


if ($this->edit) {
    ?>
    <script>
        $(function() {
            $('#familyTree_element').change(function(e) {
                var idNode = $(this).val();
                $.get('parameter/tree_family-tree/getinfoedit?idNode=' + idNode,
                    function(o){
                        $('#familyTree_labelEdit').val(o.label);
                        $('#familyTree_htmlComplement').html(o.htmlComplement);
                        $('#familyTree_editPanel > div.modal-header > h3').html(o.titlePopup);
                    }
                ).error(function(o) {
                    errorHandler(o);
                });
            });
            $('#familyTree_addPanel').on('show', function(e) {
                $.get('parameter/tree_family-tree/getlistparents?idNode=',
                    function(o){
                        $('#addAxis_parent').formActionSetOptions(o);
                    }
                ).error(function(o) {
                    errorHandler(o);
                });
            });
        });
    </script>
    <?php
}
